{{ $basePath := "data/gzipped/" }}
{{ range $fileNum := seq 1 100 }}
  {{ $filePath := printf "%s%d.json" $basePath $fileNum }}
  {{ $dataName := string $fileNum }}
  
  {{ if fileExists $filePath }}
    {{ $fileContent := readFile $filePath }}
    
    {{/* Try to unmarshal, skip on failure */}}
    {{ $data := dict }}
    {{ with transform.Unmarshal $fileContent }}
      {{ $data = . }}
    {{ else }}
      {{ warnf "Skipping unprocessable file: %s (contains invalid JSON or unsupported characters)" $filePath }}
      {{ continue }} <!-- Skip to next file -->
    {{ end }}

    {{ if $data.chapters }}
      {{ range $index, $section := $data.chapters }}
        {{/* Use safeHTML to preserve special chars in content */}}
        {{ $content := $section.content 
                      | replaceRE `\\r\\n` "\n"  
                      | replaceRE `\r\n` "\n"   
                      | replaceRE `\n+` "\n\n"
                      | safeHTML
                  }}
                  
        {{ $page := dict
          "content" (dict "mediaType" "text/markdown" "value" $content)
          "kind" "page"
          "params" (dict 
            "title" $section.title
            "chapter" (add $index 1)
            "id" $dataName
            "novel_id" $dataName
          )
          "path" (printf "%s/%d" $dataName (add $index 1))
          "title" $section.title
        }}
        {{ $.AddPage $page }}
      {{ end }}
    {{ end }}
  {{ else }}
    {{ break }} <!-- Stop if file doesn't exist -->
  {{ end }}
{{ end }}
